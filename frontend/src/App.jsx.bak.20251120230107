import React, { useEffect, useState } from "react";
import "./index.css";

const API = "http://127.0.0.1:8000";
const SERVER_SAMPLE = "/mnt/data/Siddhant_Hulle_Resume.pdf"; // your uploaded file path

export default function App() {
  const [file, setFile] = useState(null);
  const [pdfId, setPdfId] = useState(null);
  const [loading, setLoading] = useState(false);
  const [analysis, setAnalysis] = useState(null);
  const [jobText, setJobText] = useState("");
  const [error, setError] = useState(null);

  useEffect(() => {
    // clear error after 5s
    if (error) {
      const t = setTimeout(() => setError(null), 5000);
      return () => clearTimeout(t);
    }
  }, [error]);

  async function uploadFile() {
    if (!file) { setError("Select a PDF to upload."); return; }
    setLoading(true); setError(null);
    try {
      const fd = new FormData();
      fd.append("file", file);
      const res = await fetch(`${API}/upload`, { method: "POST", body: fd });
      if (!res.ok) throw new Error(await res.text().catch(()=>res.statusText));
      const j = await res.json();
      setPdfId(j.pdf_id);
      setAnalysis(null);
    } catch (e) {
      setError("Upload failed: " + (e.message || e));
    } finally { setLoading(false); }
  }

  async function analyze() {
    setLoading(true); setError(null);
    try {
      // prefer uploaded pdf_id; otherwise analyze server sample
      const payload = pdfId ? { pdf_id: pdfId, job_description: jobText || "" } : { file_path: SERVER_SAMPLE, job_description: jobText || "" };
      const res = await fetch(`${API}/analyze`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const txt = await res.text().catch(()=>null);
        throw new Error(txt || res.statusText || "Analyze failed");
      }
      const j = await res.json();
      setAnalysis(j.analysis ?? j); // accept either {analysis:...} or direct
    } catch (e) {
      setError("Analysis failed: " + (e.message || e));
      setAnalysis(null);
    } finally { setLoading(false); }
  }

  const skills = (analysis?.skills_found || analysis?.analysis?.skills_found || []) ;
  const softSkills = (analysis?.soft_skills_found || analysis?.analysis?.soft_skills_found || []);
  const missing = (analysis?.missing_skills_job || analysis?.analysis?.missing_skills_job || []);
  const suggestions = (analysis?.suggestions || analysis?.analysis?.suggestions || []);

  return (
    <div className="page">
      <header className="topbar">
        <div className="brand">
          <h1>Resume Analyzer</h1>
          <div className="tag">Clean • Professional • Deployable</div>
        </div>
        {/* top-right removed as requested */}
      </header>

      <main className="container">
        <section className="left card">
          <h3>Upload & Job Description</h3>

          <label className="label">Choose PDF</label>
          <div className="row">
            <input type="file" accept="application/pdf" onChange={(e)=>{ setFile(e.target.files[0] ?? null); setPdfId(null); setAnalysis(null); }} />
            <button className="btn primary" onClick={uploadFile} disabled={loading || !file}>{loading ? "Working..." : "Upload"}</button>
          </div>

          <div className="small muted">Selected pdf_id: <span className="mutedId">{pdfId ?? "(none)"}</span></div>

          <label className="label" style={{marginTop:12}}>Job description (optional)</label>
          <textarea className="textarea" placeholder="Paste job description to match (optional)" value={jobText} onChange={(e)=>setJobText(e.target.value)} />

          <div style={{display:"flex", gap:10, marginTop:12}}>
            <button className="btn primary" onClick={analyze} disabled={loading}>{loading ? "Analyzing..." : "Analyze"}</button>
            <button className="btn ghost" onClick={()=>{ setJobText(""); setAnalysis(null); }}>Reset</button>
          </div>

          <div className="note">Tip: if you don't upload, the built-in server sample will be analyzed.</div>

          {error && <div className="error">{error}</div>}
        </section>

        <section className="middle card large">
          <div className="scoreRow">
            <div className="scoreBox">
              <div className="score">{ analysis ? (analysis.ats_score ?? analysis?.analysis?.ats_score ?? 0) : "-" }</div>
              <div className="scoreLabel">ATS Score</div>
            </div>

            <div style={{flex:1}}>
              <div className="progressBar">
                <div className="bar" style={{width: `${Math.min(100, analysis ? (analysis.ats_score ?? analysis?.analysis?.ats_score ?? 0) : 0)}%`}}></div>
              </div>
              <div className="muted" style={{marginTop:8}}>Missing skills (job): <span className="missing">{ missing.length ? missing.join(", ") : "None" }</span></div>
            </div>
          </div>

          <hr/>

          <h4>Top suggestions</h4>
          { suggestions.length ? (
            <ol className="suggestList">{ suggestions.map((s,i)=> <li key={i}>{s}</li>) }</ol>
          ) : (
            <div className="muted">No suggestions from analyzer yet. Run analysis to get tailored suggestions.</div>
          )}
        </section>

        <aside className="right card">
          <h4>Skills</h4>
          <div className="badges">
            {skills.length ? skills.map((s,i)=>(<span key={i} className="chip">{s}</span>)) : <div className="muted">No skills detected</div>}
          </div>

          <h4 style={{marginTop:16}}>Soft skills</h4>
          <div className="badges">
            {softSkills.length ? softSkills.map((s,i)=>(<span key={i} className="chip soft">{s}</span>)) : <div className="muted">None detected</div>}
          </div>
        </aside>
      </main>

      <footer className="footer">
        <div>Backend sample path used: <code>{SERVER_SAMPLE}</code></div>
      </footer>
    </div>
  );
}
